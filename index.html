<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB Translator</title>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 42rem;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 2rem;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 2rem;
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            background: #f9fafb;
            transition: all 0.2s;
        }
        
        .file-label:hover {
            border-color: #6366f1;
            background: #f5f3ff;
        }
        
        .file-label-content {
            text-align: center;
        }
        
        .file-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .file-text {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        select {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: #374151;
            background: white;
            cursor: pointer;
        }
        
        select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .btn {
            width: 100%;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #6366f1;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #4f46e5;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-icon {
            margin-right: 0.5rem;
        }
        
        .alert {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            font-size: 0.875rem;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .alert-icon {
            margin-right: 0.5rem;
        }
        
        .info-box {
            margin-top: 2rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 0.5rem;
        }
        
        .info-box h3 {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .info-box ul {
            font-size: 0.75rem;
            color: #6b7280;
            padding-left: 1.5rem;
        }
        
        .info-box li {
            margin-bottom: 0.25rem;
        }
        
        .success-section {
            margin-top: 1.5rem;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const EPUBTranslator = () => {
            const [file, setFile] = useState(null);
            const [targetLang, setTargetLang] = useState('sk');
            const [status, setStatus] = useState('idle');
            const [progress, setProgress] = useState('');
            const [downloadUrl, setDownloadUrl] = useState(null);
            const [error, setError] = useState('');

            const languages = [
                { code: 'sk', name: 'Slovak' },
                { code: 'cs', name: 'Czech' },
                { code: 'en', name: 'English' },
                { code: 'es', name: 'Spanish' },
                { code: 'fr', name: 'French' },
                { code: 'de', name: 'German' },
                { code: 'it', name: 'Italian' },
                { code: 'pt', name: 'Portuguese' },
                { code: 'ru', name: 'Russian' },
                { code: 'ja', name: 'Japanese' },
                { code: 'zh-CN', name: 'Chinese (Simplified)' },
                { code: 'ko', name: 'Korean' },
                { code: 'ar', name: 'Arabic' },
            ];

            const handleFileChange = (e) => {
                const selectedFile = e.target.files[0];
                if (selectedFile && selectedFile.name.endsWith('.epub')) {
                    setFile(selectedFile);
                    setError('');
                    setStatus('idle');
                    setDownloadUrl(null);
                } else {
                    setError('Please select a valid .epub file');
                    setFile(null);
                }
            };

            const translateEPUB = async () => {
                if (!file) {
                    setError('Please select an EPUB file first');
                    return;
                }

                setStatus('processing');
                setProgress('Extracting EPUB...');
                setError('');

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const zip = await JSZip.loadAsync(arrayBuffer);
                    setProgress('EPUB extracted successfully');

                    const xhtmlFiles = [];
                    zip.forEach((relativePath, zipEntry) => {
                        if (relativePath.endsWith('.xhtml') || relativePath.endsWith('.html')) {
                            xhtmlFiles.push(relativePath);
                        }
                    });

                    if (xhtmlFiles.length === 0) {
                        throw new Error('No XHTML files found in EPUB');
                    }

                    setProgress(`Found ${xhtmlFiles.length} files to translate`);

                    for (let i = 0; i < xhtmlFiles.length; i++) {
                        const filePath = xhtmlFiles[i];
                        setProgress(`Translating ${i + 1}/${xhtmlFiles.length}: ${filePath.split('/').pop()}`);
                        
                        const content = await zip.file(filePath).async('string');
                        const translatedContent = await translateXHTML(content, targetLang);
                        
                        zip.file(filePath, translatedContent);
                    }

                    setProgress('Creating translated EPUB...');

                    const blob = await zip.generateAsync({ type: 'blob' });
                    const url = URL.createObjectURL(blob);
                    
                    setDownloadUrl(url);
                    setStatus('success');
                    setProgress('Translation complete!');
                } catch (err) {
                    console.error('Translation error:', err);
                    setError(err.message || 'An error occurred during translation');
                    setStatus('error');
                }
            };

            const translateXHTML = async (xhtmlContent, targetLang) => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(xhtmlContent, 'application/xml');

                const parseError = doc.querySelector('parsererror');
                if (parseError) {
                    console.warn('XML parsing error, attempting HTML parsing');
                    const htmlDoc = parser.parseFromString(xhtmlContent, 'text/html');
                    return translateDOM(htmlDoc, targetLang);
                }

                return translateDOM(doc, targetLang);
            };

            const translateDOM = async (doc, targetLang) => {
                const skipTags = ['script', 'style', 'code', 'pre'];
                const translatableAttrs = ['alt', 'title', 'aria-label', 'placeholder'];
                
                const textNodes = [];
                const walker = document.createTreeWalker(
                    doc.documentElement || doc.body,
                    NodeFilter.SHOW_TEXT,
                    {
                        acceptNode: (node) => {
                            const parent = node.parentElement;
                            if (!parent) return NodeFilter.FILTER_REJECT;
                            
                            const tagName = parent.tagName.toLowerCase();
                            if (skipTags.includes(tagName)) return NodeFilter.FILTER_REJECT;
                            
                            if (node.textContent.trim()) {
                                return NodeFilter.FILTER_ACCEPT;
                            }
                            return NodeFilter.FILTER_REJECT;
                        }
                    }
                );

                let node;
                while (node = walker.nextNode()) {
                    textNodes.push(node);
                }

                for (const textNode of textNodes) {
                    const original = textNode.textContent;
                    const trimmed = original.trim();
                    if (trimmed) {
                        try {
                            const translated = await translateText(trimmed, targetLang);
                            const leadingWS = original.match(/^\s*/)[0];
                            const trailingWS = original.match(/\s*$/)[0];
                            textNode.textContent = leadingWS + translated + trailingWS;
                        } catch (err) {
                            console.error('Translation error for text:', trimmed, err);
                        }
                    }
                }

                const allElements = doc.querySelectorAll('*');
                for (const elem of allElements) {
                    const tagName = elem.tagName.toLowerCase();
                    if (skipTags.includes(tagName)) continue;

                    for (const attr of translatableAttrs) {
                        const value = elem.getAttribute(attr);
                        if (value && value.trim()) {
                            try {
                                const translated = await translateText(value.trim(), targetLang);
                                elem.setAttribute(attr, translated);
                            } catch (err) {
                                console.error('Translation error for attribute:', attr, err);
                            }
                        }
                    }
                }

                const serializer = new XMLSerializer();
                return serializer.serializeToString(doc);
            };

            const translateText = async (text, targetLang) => {
                try {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 1000,
                            messages: [{
                                role: 'user',
                                content: `Translate the following text to ${targetLang}. Return ONLY the translated text, nothing else:\n\n${text}`
                            }]
                        })
                    });

                    const data = await response.json();
                    return data.content[0].text.trim();
                } catch (err) {
                    console.error('API translation error:', err);
                    return text;
                }
            };

            const downloadTranslated = () => {
                if (downloadUrl) {
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = file.name.replace('.epub', `.${targetLang}.epub`);
                    a.click();
                }
            };

            return (
                <div className="container">
                    <div className="card">
                        <div className="header">
                            <h1>üìö EPUB Translator</h1>
                            <p>Translate your EPUB books while preserving formatting</p>
                        </div>

                        <div className="form-group">
                            <label className="label">Select EPUB File</label>
                            <input
                                type="file"
                                accept=".epub"
                                onChange={handleFileChange}
                                className="file-input"
                                id="epub-input"
                            />
                            <label htmlFor="epub-input" className="file-label">
                                <div className="file-label-content">
                                    <div className="file-icon">üì§</div>
                                    <span className="file-text">
                                        {file ? file.name : 'Click to select EPUB file'}
                                    </span>
                                </div>
                            </label>
                        </div>

                        <div className="form-group">
                            <label className="label">Target Language</label>
                            <select value={targetLang} onChange={(e) => setTargetLang(e.target.value)}>
                                {languages.map((lang) => (
                                    <option key={lang.code} value={lang.code}>
                                        {lang.name}
                                    </option>
                                ))}
                            </select>
                        </div>

                        <button
                            onClick={translateEPUB}
                            disabled={!file || status === 'processing'}
                            className="btn btn-primary"
                        >
                            {status === 'processing' ? (
                                <>
                                    <span className="btn-icon animate-spin">‚è≥</span>
                                    Translating...
                                </>
                            ) : (
                                <>
                                    <span className="btn-icon">üåê</span>
                                    Translate EPUB
                                </>
                            )}
                        </button>

                        {progress && status === 'processing' && (
                            <div className="alert alert-info">
                                <span className="alert-icon animate-spin">‚è≥</span>
                                <span>{progress}</span>
                            </div>
                        )}

                        {status === 'success' && (
                            <div className="success-section">
                                <div className="alert alert-success">
                                    <span className="alert-icon">‚úÖ</span>
                                    <span>{progress}</span>
                                </div>
                                <button onClick={downloadTranslated} className="btn btn-success" style={{marginTop: '1rem'}}>
                                    <span className="btn-icon">‚¨áÔ∏è</span>
                                    Download Translated EPUB
                                </button>
                            </div>
                        )}

                        {error && (
                            <div className="alert alert-error">
                                <span className="alert-icon">‚ö†Ô∏è</span>
                                <span>{error}</span>
                            </div>
                        )}

                        <div className="info-box">
                            <h3>How it works:</h3>
                            <ul>
                                <li>Upload your EPUB file</li>
                                <li>Select target language</li>
                                <li>All XHTML content will be translated</li>
                                <li>Original formatting is preserved</li>
                                <li>Download your translated EPUB</li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<EPUBTranslator />, document.getElementById('root'));
    </script>
</body>
</html>